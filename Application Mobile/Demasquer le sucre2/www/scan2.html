<!DOCTYPE html>
<html>

<head>
    <!-- Meta tags -->
    <meta charset="utf-8" />
    <meta name="author" content="Noureddine ADJOU" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Debuger -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval' ; media-src * ; connect-src 'self' http://172.31.7.30/ ">

    <!-- Title -->
    <title>DÃ©masquer le sucre</title>

    <!-- Css Styles -->
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <!--- -->
    <script type="text/javascript" src="js/jQuery.min.js"></script>
    <script type="text/javascript" src="js/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="js/jquery.p2r.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="cordova.js"></script>


    <!-- Header -->

    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // http://www.html5rocks.com/en/tutorials/getusermedia/intro/?redirect_from_locale=fr           
        function hasGetUserMedia() {
            // Note: Opera is unprefixed.
            return !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
        }
        if (hasGetUserMedia()) {
            // Good to go!
        } else {
            alert('getUserMedia() is not supported in your browser');
        }
    </script>
</head>

<body onload="getInformation()">
    <table align="center">

        <tr>
            <!-- style="width: auto;height: auto;" -->
            <td align="center"><video id="myVideo" autoplay hidden></video></td>
            <td align="center"><canvas id="myCanvas"></canvas></td>
        </tr>
    </table>

    <img id="sugar" width="10" height="10"
src="img/sugar_block.png" style="display:none">
<p id="sucre"  > </p>



    <script>
        var video = document.getElementById("myVideo");
        var canvas = document.getElementById("myCanvas");

        window.URL = window.URL || window.webkitURL;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia ||
            navigator.msGetUserMedia;

        canvas.width = $(document).width();
        canvas.height = $(window).height();


        var ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        var myStream = null;
        var x = canvas.width / 2;
        var y = canvas.height / 2;
        var c_w = canvas.width / 6;
        var c_h = canvas.height / 6;




        function canvasPlayer() {
            if (myStream) {
                ctx.drawImage(video, 0, 0);
                //  var threshold = document.getElementById("Threshold").value;
                var currentImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
                var pixels = currentImage.data;
                var n = pixels.length;
                var meanValue, row = 0,
                    line = 0,
                    i, moved = false;

                ctx.putImageData(currentImage, 0, 0);

                ctx.beginPath();
                ctx.fillStyle = "#00FFFF";
                ctx.lineWidth = 7;
                ctx.strokeStyle = "#7FFF00";

                //Ligne verticale de gauche
                ctx.moveTo(c_w, c_h);
                ctx.lineTo(c_w, c_h * 2);
                ctx.stroke();
                ctx.moveTo(c_w, c_h * 4);
                ctx.lineTo(c_w, c_h * 5);
                ctx.stroke();


                //Ligne horizontale du bas
                ctx.moveTo(c_w, c_h * 5);
                ctx.lineTo(c_w * 2, c_h * 5);
                ctx.stroke();
                ctx.moveTo(c_w * 4, c_h * 5);
                ctx.lineTo(c_w * 5, c_h * 5);
                ctx.stroke();


                // //Ligne verticale de droite
                ctx.moveTo(c_w * 5, c_h);
                ctx.lineTo(c_w * 5, c_h * 2);
                ctx.stroke();
                ctx.moveTo(c_w * 5, c_h * 4);
                ctx.lineTo(c_w * 5, c_h * 5);
                ctx.stroke();

                // //Ligne horizontale du haut
                ctx.moveTo(c_w, c_h);
                ctx.lineTo(c_w * 2, c_h);
                ctx.stroke();
                ctx.moveTo(c_w * 4, c_h);
                ctx.lineTo(c_w * 5, c_h);
                ctx.stroke();

                var img = document.getElementById("sugar");
                //ctx.drawImage(img, 10, 10);

                drawSugar(22);


            }
        }
        function drawSugar(sugarQuantity){
            var img = document.getElementById("sugar");
               
          //document.getElementById("sucre");//.innerHTML;//=	localStorage.getItem("sucre");
            
            var i,j;
            var nb_max_width=Math.round((c_w * 4)/60); //nombre de sucre max a mettre par ligne
            var offset=(c_w*4-4*60)/2;
            var nb_max_height=Math.round((c_h * 4)/60); //nombre de lignes de sucre a afficher
            //alert(nb_max_width);
            //alert(nb_max_height);
            //ctx.drawImage(img,c_w, c_h * 5-60);


            for(i = 1; i <=nb_max_height; i++) {
               for (j = 0; j <nb_max_width; j++) {
                ctx.drawImage(img, c_w+(60*j)+offset, c_h*5-(60*i));
                    sugarQuantity=sugarQuantity-1;
                    if (sugarQuantity==0){
                        return;
                    }
                } 
            }
            
        }

        function testVideo() {
            if (navigator.getUserMedia) {
                navigator.getUserMedia(
                    // Constraints
                    {
                        video: {
                            facingMode: {
                                exact: "environment"
                            }
                        }
                    },
                    // Success Callback
                    function success(localMediaStream) {
                        try {
                            video.srcObject = localMediaStream;
                        } catch (error) {
                            video.src = window.URL.createObjectURL(localMediaStream);
                        }
                        myStream = localMediaStream;
                        // call canvasPlayer every 20ms
                        window.setInterval(canvasPlayer, 20);
                    },
                    // Error Callback
                    function fallback(err) {
                        // Log the error to the console.
                        console.log('The following error occurred when trying to use getUserMedia: ' + err);
                    }
                );
            } else {
                alert('Sorry, your browser does not support getUserMedia');
            }
        }

        function getInformation() {
            testVideo();

        }
    </script>
</body>

</html>